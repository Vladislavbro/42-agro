# План Реализации Проекта "Агро-Отчеты"

Этот документ описывает последовательность шагов для разработки сервиса обработки агро-отчетов.

## Этапы Реализации

1.  **Настройка Окружения и Зависимостей:**
    *   Обновить `requirements.txt` необходимыми библиотеками (`google-generativeai`, `google-api-python-client`, `google-auth-httplib2`, `google-auth-oauthlib`, `python-dotenv` и др.).
    *   Установить зависимости (`pip install -r requirements.txt`).
    *   Настроить файл `.env` с API-ключами для Google Gemini и Google Sheets, а также ID целевой таблицы Google Sheets (создать из `.env.example`).

2.  **Разработка Модуля Обработки Сообщений (`app/message_processing`):**
    *   `parser.py`: Реализовать функцию(и) для предварительного разбора входящего текстового сообщения. Возможно, извлечение ключевых фраз или форматирование перед отправкой в Gemini. Пока можно сделать базовую версию.
    *   `validator.py`: Реализовать базовые проверки формата сообщения (если это возможно до обращения к Gemini).

3.  **Разработка Модуля Интеграции с Gemini (`app/gemini_integration`):**
    *   `prompt_builder.py`: Создать функцию, которая формирует детальный промпт для Gemini. Промпт должен включать:
        *   Текст исходного сообщения.
        *   Четкую инструкцию по извлечению данных (Подразделение, Операция, Культура, "За день, га", "С начала операции, га", "Вал за день, ц", "Вал с начала, ц").
        *   Описание ожидаемого формата вывода (JSON с указанными ключами, использование `null` для отсутствующих значений).
        *   Инструкцию по добавлению текущей даты.
        *   Возможно, примеры (few-shot prompting), если потребуется для улучшения качества.
    *   `client.py`: Настроить клиент Gemini API (инициализация, обработка API-ключа из `.env`). Реализовать функцию отправки промпта в Gemini и получения ответа.
    *   `extractor.py`: Реализовать функцию для безопасного извлечения и валидации JSON из ответа Gemini.

4.  **Эксперименты и Отладка Промптов (в `notebooks/gemini-test.ipynb`):**
    *   Использовать ноутбук для тестирования различных вариантов промптов на примерах сообщений.
    *   Добиться стабильного и корректного извлечения данных в формате JSON от Gemini.

5.  **Разработка Модуля Интеграции с Google Sheets (`app/google_sheets_integration`):**
    *   `client.py`: Настроить аутентификацию для Google Sheets API (вероятно, через сервисный аккаунт). Инициализировать клиент.
    *   `writer.py`: Реализовать функцию, которая принимает извлеченный JSON и ID таблицы/листа, форматирует данные и добавляет новую строку в Google Sheet.

6.  **Сборка Основного Приложения (`app/main.py`):**
    *   Реализовать основной поток выполнения:
        *   Загрузка конфигурации (`config.py`, `.env`).
        *   Получение нового сообщения (пока можно симулировать чтением из файла или аргументом командной строки).
        *   Вызов парсера/валидатора.
        *   Вызов `prompt_builder`.
        *   Вызов клиента Gemini (`gemini_integration.client`).
        *   Вызов экстрактора (`gemini_integration.extractor`).
        *   Вызов писателя Google Sheets (`google_sheets_integration.writer`).
        *   Логирование процесса и обработка ошибок.

7.  **Тестирование:**
    *   Написать юнит-тесты для `parser.py`, `prompt_builder.py`, `extractor.py`, `writer.py` (с использованием моков для внешних API).
    *   Провести интеграционное тестирование всего потока на реальных примерах сообщений.

8.  **Рефакторинг и Доработка:**
    *   Проанализировать узкие места, улучшить обработку ошибок, оптимизировать промпты.
    *   Рассмотреть добавление более сложных правил валидации или парсинга, если потребуется.

9.  **(Опционально) Развертывание:**
    *   Определить способ запуска сервиса (скрипт по расписанию, облачная функция, небольшой веб-сервис).
    *   Подготовить инструкции по развертыванию.

Этот план можно корректировать в процессе работы. 